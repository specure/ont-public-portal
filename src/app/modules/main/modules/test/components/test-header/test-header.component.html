<ng-container class="nt-test-header">
  <ul class="nt-test-header__list">
    @for (stage of stages; track stageTitle(i, stage); let i = $index) {
      <ng-container *ngTemplateOutlet="progressItem; context: {
        $implicit: stage,
        index: i + 1,
        isVisible: isStageVisible(stage),
        progress: stage.progress(progress$ | async)
      }"></ng-container>
    }
  </ul>
</ng-container>

<ng-template #progressItem
  let-stage let-progress="progress" let-isVisible="isVisible" let-index="index"
  >
  @if (isVisible) {
    <li *transloco="let t" class="nt-test-header__item"
      [matTooltipClass]="'nt-test-header-tooltip'"
      [matTooltip]="t(stage.title + '_tooltip')"
      [ngClass]="{
        'nt-test-header__item--active': progress > 0
      }"
      >
      <header class="nt-test-header__title">
        @if (shouldShowPhaseCounter(index)) {
          <span>{{ t('test.header_phase') }} </span>
        }
        <span>{{ t(stage.title) }}</span>
        @if (shouldShowPhaseCounter(index)) {
          <span class="nt-test-header__counter"
          > ({{ index }}/{{ totalStages }})</span>
        }
      </header>
      <section class="nt-test-header__progress-container">
        <div class="nt-test-header__progress" [style.transform]="'translateX(' + progress + '%)'"></div>
      </section>
    </li>
  }
</ng-template>